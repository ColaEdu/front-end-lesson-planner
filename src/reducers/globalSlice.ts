// Import the required libraries and methods
import { createSlice, PayloadAction } from '@reduxjs/toolkit';
import { streamOpenAI, getDocRecord } from '../server/openai';
// Define the initial state of the global store
interface GlobalState {
  text: string;
  editId: string;
  aiLoading: boolean;
}
const initialState: GlobalState = {
  text: '',
  editId: '',
  aiLoading: false,
};

export const callOpenAI = (query) => async (dispatch: any) => {
  dispatch(settext(''));
  const headers = {
    'Content-Type': 'application/json'
  };

  const body = JSON.stringify({
    textBookName: query.textBookName,
    teachingTheme: query.teachingTheme,
    messages: [
      {
        role: 'user',
        content: `标准化教案的格式如下：
        # 《{课文标题}》教案
        ## 一、教材分析
        ## 二、教学目标
        ## 三、教学重点
        ## 四、教学难点
        ## 五、课时安排
        ## 六、教学资源准备
        ## 七、教学过程
        `
      },
      {
        role: 'user',
        content: `请按以下要求生成一篇标准化结构的教案：课本:${query.textBookName},课文标题:${query.title},课文内容:${query.content}`
      }]
  });

  const response = await fetch('http://43.134.126.166:3001/lessonPlan', {
    method: 'POST',
    headers,
    body
  });

  const reader = response.body.getReader();
  let chunks = '';
  let texts = '';
  while (true) {
    const { done, value } = await reader.read();
    if (done) {
      break;
    }
    chunks += new TextDecoder('utf-8').decode(value);
    texts += chunks;
    dispatch(settext(texts))
    try {
      // const result = JSON.parse(chunks);
      // console.log(result);
      chunks = '';
    } catch (e) {
      // incomplete JSON data, keep reading
    }
  }
}


export const fetchDocRecord = (params: any) => async (dispatch: any) => {
  try {
    const text: string = await getDocRecord(params);
    dispatch(settext(text));
  } catch (error) {
    console.error('Error fetching data:', error);
  }
};

export const fetchAI = (params: any) => async (dispatch: any) => {
  try {
    dispatch(setAIloading(true));
    const data = await streamOpenAI(params);

    console.log('res--', data)
    dispatch(setAIloading(false));
  } catch (error) {
    dispatch(setAIloading(false));
    console.error('Error fetching data:', error);
  }
};
// Create the globalSlice using createSlice from Redux Toolkit
const globalSlice = createSlice({
  name: 'global',
  initialState,
  reducers: {
    settext: (state, action: PayloadAction<string>) => {
      state.text = action.payload;
    },
    seteditId: (state, action: PayloadAction<string>) => {
      state.editId = action.payload;
    },
    setAIloading: (state, action: PayloadAction<boolean>) => {
      state.aiLoading = action.payload;
    },
  },
});

// Export the actions generated by the globalSlice
export const { settext, seteditId, setAIloading } = globalSlice.actions;

// Export the globalSlice reducer
export default globalSlice;